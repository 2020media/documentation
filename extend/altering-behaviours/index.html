<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Altering behaviours - Aegir Hosting System</title>
  

  <link rel="shortcut icon" href="../../_images/favicon.ico">
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../_css/toc.css" rel="stylesheet">
  <link href="../../_css/menu.css" rel="stylesheet">
  <link href="../../_css/images.css" rel="stylesheet">
  <link href="../../_css/style.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Altering behaviours";
    var mkdocs_page_input_path = "extend/altering-behaviours.md";
    var mkdocs_page_url = "/extend/altering-behaviours/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 
  <script src="../../_js/menu.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Aegir Hosting System</a>
        <div role="search">
  <form id ="rtd-search-form-alt" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../quick-start/">Quick start</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../install/">Install</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Install</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../install/upgrade/">Upgrade</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../install/uninstall/">Uninstall</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../usage/">Using Aegir</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Using Aegir</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/verify/">Verifying servers, platforms and sites</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/sites/">Sites</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Sites</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/sites/tasks/">Site tasks</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/sites/aliases/">Site aliases</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/sites/importing/">Importing sites</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/platforms/">Platforms</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Platforms</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/platforms/tasks/">Platform tasks</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/advanced/">Advanced features</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Advanced features</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/advanced/ssl/">SSL</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/advanced/remote-servers/">Multiple servers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/advanced/clients/">Access control</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../usage/advanced/provisionacl/">ProvisionACL</a>
        
    </li>

        
    </ul>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../">Extending Aegir</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Extending Aegir</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../frontend/">Frontend</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../backend/">Backend</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Altering behaviours</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#altering-aegirs-behaviours">Altering Aegir's Behaviours</a></li>
                
                    <li><a class="toctree-l4" href="#overriding-site-specific-php-values">Overriding site-specific PHP values</a></li>
                
                    <li><a class="toctree-l4" href="#injecting-into-settingsphp">Injecting into settings.php</a></li>
                
                    <li><a class="toctree-l4" href="#injecting-into-drushrcphp">Injecting into drushrc.php</a></li>
                
                    <li><a class="toctree-l4" href="#injecting-into-site-vhosts">Injecting into site vhosts</a></li>
                
                    <li><a class="toctree-l4" href="#injecting-into-platform-wide-vhosts-htaccess">Injecting into platform-wide vhosts (.htaccess)</a></li>
                
                    <li><a class="toctree-l4" href="#injecting-into-server-wide-vhosts">Injecting into server-wide vhosts</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../contrib/">Contributed projects</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../develop/">Developing Aegir</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing Aegir</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/terminology/">Design and terminology</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/architecture/">Architecture</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/provision/">Provision</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Provision</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/provision/contexts/">Contexts</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../develop/repositories/">Projects repositories</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../help/contact/">Help</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../community/">Community</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Community</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/code-of-conduct/">Code of Conduct</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/core-team/">Core team</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Core team</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/core-team/criteria/">Criteria</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/core-team/leadership/">Leadership</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/core-team/welcome/">Welcoming a new member</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/release-process/">Release process</a>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Release process</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/release-process/debian-packaging/">Debian packaging</a>
        
    </li>

        
    </ul>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../community/resources/">Resources</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.4/">Release notes</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Release notes</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.0/">3.0</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.1/">3.1</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.2/">3.2</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.3/">3.3</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.4/">3.4</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.5/">3.5</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.6/">3.6</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../release-notes/3.7/">3.7</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Aegir Hosting System</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Extending Aegir &raquo;</li>
        
      
    
    <li>Altering behaviours</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/aegir-project/documentation" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="altering-aegirs-behaviours">Altering Aegir's Behaviours</h1>
<div class="toc">
<ul>
<li><a href="#altering-aegirs-behaviours">Altering Aegir's Behaviours</a><ul>
<li><a href="#overriding-site-specific-php-values">Overriding site-specific PHP values</a><ul>
<li><a href="#developer-note">Developer Note</a></li>
</ul>
</li>
<li><a href="#injecting-into-settingsphp">Injecting into settings.php</a><ul>
<li><a href="#site-specific-customization">Site Specific Customization</a></li>
<li><a href="#aegir-wide-customization">Aegir-wide Customization</a></li>
</ul>
</li>
<li><a href="#injecting-into-drushrcphp">Injecting into drushrc.php</a></li>
<li><a href="#injecting-into-site-vhosts">Injecting into site vhosts</a><ul>
<li><a href="#when-would-i-want-to-do-this">When would I want to do this?</a></li>
<li><a href="#a-simple-example">A simple example</a></li>
<li><a href="#a-more-advanced-example">A more advanced example</a></li>
</ul>
</li>
<li><a href="#injecting-into-platform-wide-vhosts-htaccess">Injecting into platform-wide vhosts (.htaccess)</a></li>
<li><a href="#injecting-into-server-wide-vhosts">Injecting into server-wide vhosts</a></li>
</ul>
</li>
</ul>
</div>
<p>Aegir is capable of installing, deploying and moving your sites around, because of this ability, it has to manage the various configuration files that keep your sites running.</p>
<p>These configurations include the standard Drupal settings.php for a site, .htaccess overrides for your HTTP server, as well as HTTP 'VirtualHost' or 'vhost' configuration files that tell your HTTP server where your site is located on the server.</p>
<p>A caveat of this system is that Aegir regularly re-generates these configuration files to apply new changes that have been made to the sites or platforms, as well as doing so as a safety mechanism to ensure these files are 'sane'.</p>
<p>For example, if you make a modification to a site vhost or settings.php and it breaks your site, running a 'Verify' task on the site should restore the file back to how it was.</p>
<p>However, sometimes it is necessary to add custom configuration or overrides to these files, and you can't do that if Aegir is regularly wiping your changes.</p>
<p>Fortunately, Aegir provides a series of hooks and inclusions for overriding or injecting customizations into these files safely and persistently.</p>
<p>This chapter shows you how each of these hooks or inclusions work.</p>
<h2 id="overriding-site-specific-php-values">Overriding site-specific PHP values</h2>
<p>Sometimes it is useful to override certain PHP values on a per-site basis, but changes to php.ini are generally server-wide. Depending on the value you want to override, a couple of options present themselves.</p>
<p>First, let's consider where PHP values can be changed. The PHP Manual <a href="http://www.php.net/manual/en/ini.list.php">lists php.ini</a>  directives, and under the "Changeable" column, indicates where a configuration setting may be set. If your value shows either PHP_INI_USER or PHP_INI_ALL, then the easiest way to change this value would be using ini_set() in a local.settings.php file:</p>
<pre><code>&lt;?php
@ini_set('memory_limit', '128M');
</code></pre>
<p>The <code>local.settings.php</code> file should be placed in the root of your drupal site, e.g. /sites/sitename/local.settings.php.</p>
<p>On the other hand, if the changes mode is either PHP_INI_PERDIR or PHP_INI_SYSTEM, php_ini() won't work. In this case, the solution is to inject the value into the vhost. Since vhosts are managed by Aegir, manually adding an override to /var/aegir/config/server_master/apache/vhost.d/<uri> would get blown away the next time that the site is verified.</p>
<p>As described in the <a href="#injecting-into-site-vhosts">Injecting into site vhosts</a> section, we can inject values into vhosts using a Drush hook. For example, to raise the file upload size limit on http://ergonlogic.com, we add the following code in /var/aegir/.drush/ergonlogiccom.drush.inc:</p>
<pre><code>&lt;?php
  function ergonlogiccom_provision_apache_vhost_config($uri, $data) {
    if ($uri == "ergonlogic.com") {
      drush_log("Overriding PHP file size values. See .drush/ergonlogiccom.drush.inc");
      return array("php_value upload_max_filesize 100M", "php_value post_max_size 200M");
   }
}
</code></pre>
<p>This results in the insertion of the following lines into /var/aegir/config/server_master/apache/vhost.d/ergonlogic.com:
php_value upload_max_filesize 100M
php_value post_max_size 200M</p>
<p>Also, in the verify task log I get the following informative message:
Overriding PHP file size values. See .drush/ergonlogiccom.drush.inc</p>
<h3 id="developer-note">Developer Note</h3>
<p>One challenge this technique may present is inspecting the values of the parameters passed into this function. It appears that the Hostmaster site doesn't get bootstrapped, and so common debugging tools (such as devel.module's dd()) aren't available. However drush_log() is, and when called, will push arbitrary messages back into your Aegir site's verify task log.</p>
<p>So sticking the following into the function above can help:</p>
<pre><code>&lt;?php
  drush_log("$uri: " . print_r($uri, TRUE));
</code></pre>
<p>ps
    ?&gt;</p>
<h2 id="injecting-into-settingsphp">Injecting into settings.php</h2>
<p>Every web site in an Aegir environment has a Drupal configuration file settings.php in /sites/example.com directory. Web administrators often need to make changes to this file; however, the Aegir system also manages this file and any manual customizations will be lost when a site is verified.</p>
<p>Fortunately, there are two mechanisms to ensure that your customizations can be preserved. If you look in the bottom of an Aegir settings.php file you will see references to two files local.settings.php and global.inc.</p>
<pre><code>&lt;?php
  # Additional host wide configuration settings. Useful for safely specifying configuration settings.
  if (file_exists('/var/aegir/config/includes/global.inc')) {
    include_once('/var/aegir/config/includes/global.inc');
  }

 # Additional site configuration settings. Allows to override global settings.
 if (file_exists('/var/aegir/example-platform/sites/example.com/local.settings.php')) {
   include_once('/var/aegir/example-platform/sites/example.com/local.settings.php');
 }
</code></pre>
<p>If these files exist they are loaded at run time by Drupal. As you can probably surmise from the paths to these files, local.settings.php is for site-specific customizations and global.inc is for Aegir-wide customization.</p>
<p>Let's look at these files in more detail. We'll use customization of user session cookies as an example. If you look at the settings.php file generated by Aegir you see that it sets more conservative php settings for cookies (@ini_set('session.cookie_lifetime',  0); i.e. cookies expire immediately) than are in the default.settings.php packaged with Drupal (@ini_set('session.cookie_lifetime',  2000000); i.e. 2 million seconds, which is just over 23 days).
Site-specific Customization</p>
<h3 id="site-specific-customization">Site Specific Customization</h3>
<p>The local.settings.php file by default does not exist in a new Aegir site installation so you have to create it. Continuing with our example of user session cookies, let's override the Aegir default.</p>
<pre><code>&lt;?php
  # site-specific Drupal customization

  # override Aegir-generated cookie policy for sites - set cookies to expire after a week (604,800 seconds)
  @ini_set('session.cookie_lifetime', 604800);
</code></pre>
<p>Note that because local.settings.php is included after the variables are set in the main settings.php it's customizations takes precedence.</p>
<p>Now, whenever you clone a site or migrate it between platforms, Aegir moves a copy of local.settings.php as well.
Using drush_hook_provision_drupal_config</p>
<p>You can also use the API to add module-specific site configurations with hook_provision_drupal_config</p>
<pre><code>&lt;?php
  * Append PHP code to Drupal's settings.php file.
  *
  * To use templating, return an include statement for the template.
  *
  * @param $uri
  *   URI for the site.
  * @param $data
  *   Associative array of data from provisionConfig_drupal_settings::data.
  *
  * @return
  *   Lines to add to the site's settings.php file.
  *
  * @see provisionConfig_drupal_settings
  */
  function drush_hook_provision_drupal_config($uri, $data, $config) {
    return '$conf[\'reverse_proxy\'] = TRUE;';
  }
</code></pre>
<p>For example it could look like this</p>
<pre><code>&lt;?php
  function drupalwiki_provision_drupal_config($uri, $data, $config) {
    $extra = drush_get_option('site_extra_settings', '');
  // remove window CR
  $extra = str_replace("\r",'',$extra);
    return $extra;
  }
</code></pre>
<p>That is used to add the site settings added by the UI in the hosting backend implemented in <a href="https://github.com/EugenMayer/hosting_site_settings">https://github.com/EugenMayer/hosting_site_settings</a></p>
<h3 id="aegir-wide-customization">Aegir-wide Customization</h3>
<p>In some situations you may want to implement the same configuration settings on all your Aegir sites. This is where global.inc comes in. Note that global.inc is now included in settings.php before local.settings.php, so that Aegir system administrators no longer retain the ability to override configuration changes in local.settings.php, but instead it is possible to override global settings per site <a href="https://www.drupal.org/node/1044938">read why this has been changed</a>: this change is available since 0.4-rc1 release.</p>
<p>For example, say the system administrator wanted to limit users' session lifetimes to a maximum of one day they could create a global.inc as follows:</p>
<pre><code>&lt;?php
# Aegir-wide Drupal customization

# override Aegir-generated cookie policy for all sites - set cookies to expire after a day (86,400 seconds)
  @ini_set('session.cookie_lifetime', 86400);
</code></pre>
<p>You can even set more granular policy within global.inc (however it makes more sense to keep site-specific overrides in the local.settings.php):</p>
<pre><code>&lt;?php
# Aegir-wide Drupal customization

# override Aegir-generated cookie policy for all sites - set cookies to expire after a day (86,400 seconds)
  @ini_set('session.cookie_lifetime', 86400);

# Make the aegir front-end server more secure by expiring cookies immediately
  if (preg_match("/hostmaster/", $conf['install_profile'])) {
# set cookies to expire immediately on hostmaster
    @ini_set('session.cookie_lifetime', 0);
  }
</code></pre>
<p>If you are using Aegir to manage multiple remote webservers, you will need to run the Verify task on the webserver in order to push global.inc to the remote machine.</p>
<h2 id="injecting-into-drushrcphp">Injecting into drushrc.php</h2>
<p>The drushrc.php file can be changed in two ways:</p>
<ul>
<li>changing the templates used for the Drushrc context see the <a href="http://api.aegirproject.org/api/Provision/provision.api.php/function/hook_provision_config_load_templates/7.x-3.x">hook_provision_config_load_templates() hook</a></li>
<li>creating a local.drushrc.php file in the site-specific folder (e.g. sites/example.com/local.drushrc.php</li>
</ul>
<h2 id="injecting-into-site-vhosts">Injecting into site vhosts</h2>
<p>Aegir provides some hook functions in its API, one of which allows you to inject extra configuration snippets into your Apache vhost files for sites.</p>
<h3 id="when-would-i-want-to-do-this">When would I want to do this?</h3>
<p>A good example for this is when you may need to inject a custom Rewrite rule that goes beyond what the Aegir Aliases 'redirection' feature provides.</p>
<p>Or, perhaps you have to inject some htpasswd mod_auth password protection for your site, or perhaps a CustomLog definition. The <a href="https://drupal.org/project/hosting_tasks_extra">http_basic_auth</a> module uses this. <a href="http://cgit.drupalcode.org/hosting_tasks_extra/tree/http_basic_auth?id=HEAD">code</a>.</p>
<p>Typically you'd just add what you need to the vhost file, but the problem is that Aegir manages these vhosts, and on every Verify task, will rewrite the config from a template, blowing away your changes in the process. Ouch!</p>
<p>Fortunately there is a very easy and elegant solution to this problem to save your configurations persistently across Verify tasks and the like, by means of invoking the Provision hook provision_apache_vhost_config(), or, if you are using Nginx, provision_nginx_vhost_config() (and just replace the below examples with 'nginx' instead of 'apache' where necessary). Below "mig5" is just an example, you can replace this with anything as drush looks for all *.drush.inc files in ~aegir/.drush</p>
<h3 id="a-simple-example">A simple example</h3>
<p>In this example I'll inject a simple 'ErrorLog' apache definition into a vhost to save the site error logs to a file.</p>
<p>Create a file in ~aegir/.drush called mig5.drush.inc. (Choose <any> prefix for the file name <any>.drush.inc).</p>
<p>Add this snippet of PHP to the file:</p>
<pre><code>&lt;?php
  function mig5_provision_apache_vhost_config($uri, $data) {
     return "ErrorLog /var/aegir/" . $uri . ".error.log";
  }
</code></pre>
<p>You can use <em>any</em> prefix for the function name <em>any</em>_provision_apache_vhost_config</p>
<p>Execute on the server</p>
<pre><code>drush cache-clear drush
</code></pre>
<p>Finally, install a site or verify an existing one</p>
<p>Check your site's vhost config file (in /var/aegir/config/server_master/apache/vhost.d/) and you'll see the line has been injected into the '#Extra configuration' area of the vhost</p>
<pre><code>&lt;VirtualHost *:80&gt;

  DocumentRoot /var/aegir/hostmaster-HEAD

  ServerName 1.mig5-forge.net
  SetEnv db_type  mysqli
  SetEnv db_name  1mig5forgenet
  SetEnv db_user  1mig5forgenet
  SetEnv db_passwd  X7KzsFhxhp
  SetEnv db_host  tardis
  SetEnv db_port  3306



# Extra configuration from modules:
  ErrorLog /var/aegir/1.mig5-forge.net.error.log
    # Error handler for Drupal &gt; 4.6.7
    &lt;Directory "/var/aegir/hostmaster-HEAD/sites/1.mig5-forge.net/files"&gt;
      SetHandler This_is_a_Drupal_security_line_do_not_remove
    &lt;/Directory&gt;

&lt;/VirtualHost&gt;
</code></pre>
<p>It's that simple! You can see that via the hook, we pass $uri and the drush data to the function, allowing me to abstract the site url so that each site will get its own error log. You could do extra PHP conditionals to ensure certain data only gets inserted into certain sites of a specific name.</p>
<p>To inject multiple lines instead of one, use an array, i.e</p>
<pre><code>&lt;?php
  function mig5_provision_apache_vhost_config($uri, $data) {
    return array("ErrorLog /var/aegir/" . $uri . ".error.log", "LogLevel warn");
  }
</code></pre>
<p>The key point of this is that the file ~aegir/.drush/mig5.drush.inc file will never be touched by Aegir, so you can rest assured your changes will be respected.</p>
<p>If you want to only inject code into a specific site, wrap your code with an if statement, i.e</p>
<pre><code>&lt;?php
  function mig5_provision_apache_vhost_config($uri, $data) {
    if ($uri === "&lt;site-name-in-aegir&gt;") {
      return array("ErrorLog /var/aegir/" . $uri . ".error.log", "LogLevel warn");
    }
  }
</code></pre>
<h3 id="a-more-advanced-example">A more advanced example</h3>
<p>Managing multiple versions of a production site can be a tricky proposition, even in Aegir. This is particularly true when you want to use the same canonical domain name to allow users to access one such site of your choosing at any given moment. For instance, in Aegir I might have a site named www.example.com (with an alias of example.com,) and a couple of alternates with the site names of test1.example.com and test2.example.com. If I suddenly decide that I want my primary domain to access test1.example.com, Aegir forces me into a tedious process that ultimately results in site downtime – I have to delete or migrate the existing www.example.com site to a new unused site name (or clone it to an unused site name, and delete the original) and then I have to migrate test1.example.com to the vacated site name www.example.com. Alternatively, I could add the www.example.com and example.com aliases to test1.example.com but then my users would just be redirected to test1.example.com.</p>
<p>Given the way Aegir manages aliases, it would actually be easier to make this switch if the desired address was never used as a site name to begin with. Instead of having the site name www.example.com alongside of the two other test sites, we might have live.example.com, with in-use aliases of www.example.com and example.com, and a rewrite instruction in the vhost that rewrites live.example.com to www.example.com. If we could easily change the rewrite instructions in that vhost, all we would need to do is move the aliases from one site to the next in the GUI (with the requisite verify tasks executed on each site in question) in order to quickly change which site was being loaded at any given moment by www.example.com. For example, if I wanted to move to test2.example.com, I would remove the www.example.com and example.com aliases from live.example.com and verify, add those aliases to test2.example.com and verify, and change my vhost so that test2 .example.com is rewritten as www.example.com. Since as previously mentioned Aegir overwrites changes to the vhost during the verify process, the solution is to use the provision_apache_vhost_config hook in a drush.inc file to selectively add the rewrite information to the vhost when verifying the site that we want our canonical domain to refer to.</p>
<pre><code>&lt;?php
  function aliasredirects_provision_apache_vhost_config($uri, $data) {
    // the uri to check here is the name of the site in Aegir
    if ($uri === "test2.example.com") {
        $rval[] = "";
        $rval[] = "# Forces redirect to one uri";
        $rval[] = "RewriteEngine On";
        // if the host is not example.com
        $rval[] = "RewriteCond %{HTTP_HOST} !^example.com$ [NC]";
        // rewrite to example.com with a 301 redirect
        $rval[] = "RewriteRule ^(.*)$ http://example.com$1 [R=301,L]";
        $rval[] = "";
        return $rval;
    }
}
</code></pre>
<p>When we want to switch again, say to test1.example.com, We could update the code to look for the test1.example.com uri.</p>
<h2 id="injecting-into-platform-wide-vhosts-htaccess">Injecting into platform-wide vhosts (.htaccess)</h2>
<p>Using a .htaccess with an Allow Override all directive in Apache can be a major performance killer, because it requires Apache to stat each subdirectory of the codebase looking for overrides in .htaccess.</p>
<p>As a result, Aegir disables the reading of the Drupal .htaccess in the runtime environment.</p>
<p>This does not mean that the .htaccess is not needed. Instead, when you run the Verify task against a Platform, the .htaccess is studied by Aegir and its contents are copied into the platform-wide Apache vhost configuration, typically located in /var/aegir/config/server_master/apache/platform.d</p>
<p>Need to make a modification to the .htaccess? Simple: you can simply edit it in-place as you normally would, but you must re-Verify the platform in Aegir afterward, in order for those new or modified settings to be 'loaded in' to the platform vhost file.</p>
<p>The end result is improved performance for your sites, without losing any functionality, as you can still customize the .htaccess to your liking.</p>
<h2 id="injecting-into-server-wide-vhosts">Injecting into server-wide vhosts</h2>
<p>Changing maximum filesize upload is common when setting up sites in Drupal. As described in <a href="#overriding-site-specific-php-values">Overriding site-specific PHP values</a> you can change value for each site created with Aegir by adding a .drush.inc file in /var/aegir/.drush directory. But wouldn´t it be nice to be able to do it server-wide?</p>
<p>For instance, you could create a file called global_settings.drush.inc, place it in /var/aegir/.drush and put in the following code:</p>
<pre><code>&lt;?php
  function globalsettings_provision_apache_vhost_config($uri, $data) {
  drush_log("Overriding PHP file size values. See .drush/global_settings.drush.inc");
  return array("php_value upload_max_filesize 100M", "php_value post_max_size 200M");
}
</code></pre>
<p>Here below is the same code from ergonlogic demonstrating how to create a domainname.drush.inc file using the domain name as a condition before the code injection. This then would only affect the specific site and not apply server wide.</p>
<pre><code>&lt;?php
function ergonlogiccom_provision_apache_vhost_config($uri, $data) {
if ($uri == "ergonlogic.com") {
  drush_log("Overriding PHP file size values. See .drush/ergonlogiccom.drush.inc");
  return array("php_value upload_max_filesize 100M", "php_value post_max_size 200M");
 }
}
</code></pre>
<p>One further example from staceyb on injecting a rewrite rule. Name the file the same as the function and place it in /var/aegir/.drush</p>
<pre><code>&lt;?php
  function aliasredirects_provision_apache_vhost_config($uri, $data) {
  // the uri to check here is the name of the site in Aegir
  if ($uri === "example.com") {
    $rval[] = "";
    $rval[] = "RewriteEngine On";
    // check to see if https is not on first
    $rval[] = "RewriteCond %{HTTPS} !=on";
    // rewrite to https with a 301 redirect
    $rval[] = "RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]";
    $rval[] = "";
    return $rval;
  }
}
</code></pre>
<p>Make sure you Verify your site after you create the file. Then scroll through the log and find the message you added in the code.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../contrib/" class="btn btn-neutral float-right" title="Contributed projects">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../backend/" class="btn btn-neutral" title="Backend"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/aegir-project/documentation" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../backend/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../contrib/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
